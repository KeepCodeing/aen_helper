{% extends "base.html" %}

{% block title %}éšæœºæµè§ˆ{% endblock %}
{% block body_class %}index-page{% endblock %}

{% block content %}
<div x-data="randomImageApp()" 
     @scroll.window="handleScroll()"
     style="height: 100%; width: 100%;">

    <div class="nav" :class="{ 'nav-hidden': !showNav }">
        <div class="nav-group left">
            <a href="/grid">ğŸ§± ç½‘æ ¼</a>
            <a href="/videos">ğŸ¬ è§†é¢‘</a>
            <a href="/tags">ğŸ·ï¸ æœç´¢</a>
			<a href="/explore">ğŸ“‚ ç›®å½•</a>
			<a href="/rescan">ğŸ”„ æ‰«æ</a>
        </div>
        <div class="nav-group right">
            <template x-if="folderPath">
                <a :href="'/folder/' + encodeURIComponent(folderPath)" 
                   class="folder-btn nav-title" 
                   x-text="'ğŸ“‚ ' + folderPath.split('/').pop()">
                </a>
            </template>
        </div>
    </div>

    <div id="index-container" 
		@click="fetchImage()"
		@touchstart="handleTouchStart($event)"
		@touchmove="handleTouchMove($event)"
		title="ç‚¹å‡»åˆ‡æ¢ä¸‹ä¸€å¼ ">
        
        <div x-show="loading" 
             class="loading-overlay"
             x-transition.opacity.duration.300ms
             x-cloak>
             <span>â³ åŠ è½½ä¸­...</span>
        </div>

        <template x-if="imageUrl">
            <img :src="imageUrl" 
                 alt="éšæœºå›¾ç‰‡" 
                 @load="loading = false"
                 :class="loading ? 'opacity-0' : 'opacity-100'"
                 class="transition-opacity">
        </template>
    </div>
</div>

<script>
function randomImageApp() {
    // åŒæ­¥æ¢å¤å†å²çŠ¶æ€ï¼Œé˜²æ­¢è¿”å›æ—¶é—ªçƒ
    let restoredState = null;
    const navEntries = performance.getEntriesByType("navigation");
    const navType = navEntries.length > 0 ? navEntries[0].type : '';
    if (navType === 'back_forward' && history.state && history.state.imageUrl) {
        restoredState = history.state;
    }

    return {
        imageUrl: restoredState ? restoredState.imageUrl : '',
        folderPath: restoredState ? restoredState.folderPath : '',
        loading: !restoredState,
        isFetching: false,
        // å¯¼èˆªæ æ§åˆ¶
        showNav: true,
        lastScrollY: 0,

        init() {
            if (!this.imageUrl) this.fetchImage();
        },

        handleScroll() {
            // é¦–é¡µé€šå¸¸ä¸æ»šåŠ¨ï¼Œä½†ä¿ç•™é€»è¾‘ä»¥å¤‡é¡µé¢å†…å®¹æ‰©å……
            const currentScrollY = window.scrollY;
            this.showNav = currentScrollY <= this.lastScrollY || currentScrollY < 50;
            this.lastScrollY = currentScrollY;
        },
		
		// --- æ–°å¢ï¼šè§¦æ‘¸ç›¸å…³çŠ¶æ€ ---
        touchStartY: 0,
        
        init() {
            if (!this.imageUrl) this.fetchImage();
        },

        // --- ä¿ç•™ï¼šPCç«¯å¦‚æœçª—å£å˜å°å‡ºç°æ»šåŠ¨æ¡æ—¶çš„å…¼å®¹ ---
        handleScroll() {
            const currentScrollY = window.scrollY;
            if (currentScrollY <= 0) return; // å¿½ç•¥é¡¶éƒ¨åå¼¹
            this.showNav = currentScrollY <= this.lastScrollY || currentScrollY < 50;
            this.lastScrollY = currentScrollY;
        },

        // --- æ–°å¢ï¼šè§¦æ‘¸å¼€å§‹ ---
        handleTouchStart(e) {
            // è®°å½•æ‰‹æŒ‡æ¥è§¦å±å¹•æ—¶çš„ Y åæ ‡
            this.touchStartY = e.touches[0].clientY;
        },

        // --- æ–°å¢ï¼šè§¦æ‘¸ç§»åŠ¨ (æ¨¡æ‹Ÿæ»šåŠ¨) ---
        handleTouchMove(e) {
            const currentY = e.touches[0].clientY;
            const diff = currentY - this.touchStartY;
            const threshold = 20; // çµæ•åº¦é˜ˆå€¼ï¼Œé˜²æ­¢è½»å¾®æŠ–åŠ¨è¯¯è§¦

            // é€»è¾‘ï¼š
            // diff > 0: æ‰‹æŒ‡å‘ä¸‹æ‹–åŠ¨ (é¡µé¢å†…å®¹é€»è¾‘ä¸Šä¸‹é™) -> ç±»ä¼¼äº"å‘ä¸Šæ»šåŠ¨" -> æ˜¾ç¤ºå¯¼èˆª
            // diff < 0: æ‰‹æŒ‡å‘ä¸Šæ‹–åŠ¨ (é¡µé¢å†…å®¹é€»è¾‘ä¸Šä¸Šå‡) -> ç±»ä¼¼äº"å‘ä¸‹æµè§ˆ" -> éšè—å¯¼èˆª
            
            if (diff > threshold) {
                this.showNav = true;
            } else if (diff < -threshold) {
                this.showNav = false;
            }
            
            // æ³¨æ„ï¼šè¿™é‡Œä¸æ›´æ–° touchStartYï¼Œå®ç°"ä¸€æ»‘åˆ°åº•"çš„æ•ˆæœ
            // å¦‚æœæƒ³è¦æ›´çµæ•çš„è¿ç»­æ»‘åŠ¨ï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸Š this.touchStartY = currentY;
        },

        async fetchImage() {
            if (this.isFetching) return;
            this.isFetching = true;
            this.loading = true;

            try {
                const response = await fetch('/api/random-image');
                const data = await response.json();
                
                const img = new Image();
                img.onload = () => {
                    this.imageUrl = '/media/' + data.path;
                    this.folderPath = data.folder;
                    // æ³¨æ„ï¼šloading çš„å…³é—­äº¤ç»™äº† img æ ‡ç­¾çš„ @load äº‹ä»¶
                    history.replaceState({
                        imageUrl: this.imageUrl,
                        folderPath: this.folderPath
                    }, '', location.href);
                };
                img.src = '/media/' + data.path;
            } catch (e) {
                console.error(e);
                this.loading = false;
            } finally {
                this.isFetching = false;
            }
        }
    }
}
</script>
{% endblock %}