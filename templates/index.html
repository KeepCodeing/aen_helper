{% extends "base.html" %}

{% block title %}éšæœºæµè§ˆ{% endblock %}
{% block body_class %}index-page{% endblock %}

{% block content %}
<div x-data="randomImageApp()" 
     @scroll.window="handleScroll()"
     style="height: 100%; width: 100%;">

    <div class="nav" :class="{ 'nav-hidden': !showNav }">
        <div class="nav-group left">
            <a href="/grid">ğŸ§± ç½‘æ ¼</a>
            <a href="/videos">ğŸ¬ è§†é¢‘</a>
            <a href="/tags">ğŸ·ï¸ æ ‡ç­¾</a>
			<a href="/explore">ğŸ“‚ ç›®å½•</a>
			<a href="/settings">âš™ï¸ è®¾ç½®</a>
			<a href="/rescan">ğŸ”„ æ‰«æ</a>
		</div>
        <div class="nav-group right">
            <template x-if="folderPath">
                <a :href="'/folder/' + encodePath(folderPath)" 
                   class="folder-btn nav-title" 
                   x-text="'ğŸ“‚ ' + folderPath.split('/').pop()">
                </a>
            </template>
        </div>
    </div>

    <div id="index-container" 
		@click="fetchImage()"
		@touchstart="handleTouchStart($event)"
		@touchmove="handleTouchMove($event)"
		title="ç‚¹å‡»åˆ‡æ¢ä¸‹ä¸€å¼ ">
        
        <div x-show="loading" 
             class="loading-overlay"
             x-transition.opacity.duration.300ms
             x-cloak>
             <span>â³ åŠ è½½ä¸­...</span>
        </div>

        <template x-if="imageUrl">
            <img :src="imageUrl" 
                 alt="éšæœºå›¾ç‰‡" 
                 @load="loading = false"
                 :class="loading ? 'opacity-0' : 'opacity-100'"
                 class="transition-opacity">
        </template>
    </div>
</div>

<script>
function randomImageApp() {
    // åŒæ­¥æ¢å¤å†å²çŠ¶æ€ï¼Œé˜²æ­¢è¿”å›æ—¶é—ªçƒ
    let restoredState = null;
    const navEntries = performance.getEntriesByType("navigation");
    const navType = navEntries.length > 0 ? navEntries[0].type : '';
    if (navType === 'back_forward' && history.state && history.state.imageUrl) {
        restoredState = history.state;
    }

    return {
        imageUrl: restoredState ? restoredState.imageUrl : '',
        folderPath: restoredState ? restoredState.folderPath : '',
        loading: !restoredState,
        isFetching: false,
        // å¯¼èˆªæ æ§åˆ¶
        showNav: true,
        lastScrollY: 0,
        // è§¦æ‘¸ç›¸å…³çŠ¶æ€
        touchStartY: 0,
        
        init() {
            if (!this.imageUrl) this.fetchImage();
        },

        // ã€æ–°å¢ã€‘ï¼šä¸“é—¨é’ˆå¯¹è·¯å¾„åˆ†æ®µç¼–ç ï¼Œå®Œç¾è§£å†³ # å’Œ ? å¯¼è‡´çš„ 404
        encodePath(p) {
            if (!p) return '';
            return p.split('/').map(encodeURIComponent).join('/');
        },

        // ä¿ç•™ï¼šPCç«¯å¦‚æœçª—å£å˜å°å‡ºç°æ»šåŠ¨æ¡æ—¶çš„å…¼å®¹
        handleScroll() {
            const currentScrollY = window.scrollY;
            if (currentScrollY <= 0) return; // å¿½ç•¥é¡¶éƒ¨åå¼¹
            this.showNav = currentScrollY <= this.lastScrollY || currentScrollY < 50;
            this.lastScrollY = currentScrollY;
        },

        // è§¦æ‘¸å¼€å§‹
        handleTouchStart(e) {
            this.touchStartY = e.touches[0].clientY;
        },

        // è§¦æ‘¸ç§»åŠ¨ (æ¨¡æ‹Ÿæ»šåŠ¨)
        handleTouchMove(e) {
            const currentY = e.touches[0].clientY;
            const diff = currentY - this.touchStartY;
            const threshold = 20; 
            
            if (diff > threshold) {
                this.showNav = true;
            } else if (diff < -threshold) {
                this.showNav = false;
            }
        },

        async fetchImage() {
            if (this.isFetching) return;
            this.isFetching = true;
            this.loading = true;

            try {
                const response = await fetch('/api/random-image');
                const data = await response.json();
                
                // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šåœ¨æ­¤å¤„åˆ©ç”¨ encodePath å‡½æ•°å¯¹åç«¯ä¼ æ¥çš„è·¯å¾„è¿›è¡Œç¼–ç 
                const encodedPath = this.encodePath(data.path);
                
                const img = new Image();
                img.onload = () => {
                    // èµ‹å€¼ç»™ imageUrl è¿›è¡Œæ¸²æŸ“
                    this.imageUrl = '/media/' + encodedPath;
                    this.folderPath = data.folder;
                    
                    history.replaceState({
                        imageUrl: this.imageUrl,
                        folderPath: this.folderPath
                    }, '', location.href);
                };
                
                // é¢„åŠ è½½çš„ src ä¹Ÿè¦ä½¿ç”¨ç¼–ç åçš„è·¯å¾„
                img.src = '/media/' + encodedPath;
            } catch (e) {
                console.error(e);
                this.loading = false;
            } finally {
                this.isFetching = false;
            }
        }
    }
}
</script>
{% endblock %}