{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div data-api-url="{{ api_url }}" 
     x-data="galleryApp($el.dataset.apiUrl)" 
     @scroll.window="handleScroll()"
     x-cloak>

    <div class="nav" :class="{ 'nav-hidden': !showNav }">
        <div class="nav-group left">
            {% if request.path.startswith('/folder/') %}
                <a href="#" @click.prevent="goBack()">â¬… è¿”å›ä¸Šçº§</a>
            {% elif request.path.startswith('/tags/random/') %}
                <a href="/tags">â¬… è¿”å›è§’è‰²</a>
            {% elif is_search %}
                {% if request.args.get('folder') %}
                    <a href="#" @click.prevent="goBack()">â¬… è¿”å›ä¸Šçº§</a>
                {% else %}
                    <a href="/tags">â¬… æ ‡ç­¾ç´¢å¼•</a>
                {% endif %}
            {% else %}
                <a href="/">ğŸ  é¦–é¡µ</a>
            {% endif %}
            
            <span style="color: #444;">|</span>
            <div class="nav-title" title="{{ page_title }}">{{ page_title }}</div>
            
            {% if not request.path.startswith('/tags/random/') and not is_search and not request.path.startswith('/folder/') %}
                <a href="/grid" x-show="!baseApiUrl.includes('/api/images')">å›¾ç‰‡</a>
                <a href="/videos" x-show="!baseApiUrl.includes('/api/videos')">è§†é¢‘</a>
                <a href="/tags">æ ‡ç­¾</a>
                <a href="/explore">ç›®å½•</a>
            {% endif %}
        </div>
        <div class="nav-group right">
            {% if character_name %}
                <a href="/tags/folders/{{ character_name | urlencode }}" class="folder-btn" @click.prevent="window.location.replace($el.href)">ğŸ“‚ æ–‡ä»¶å¤¹æ¨¡å¼</a>
            {% elif is_search and search_query %}
                <a href="#" class="folder-btn" @click.prevent="toggleFolderMode()">ğŸ“‚ æ–‡ä»¶å¤¹æ¨¡å¼</a>
            {% endif %}
        </div>
    </div>

    <div class="grid-container">
		{% if subfolders %}
            {% for folder in subfolders %}
                <a href="{{ '/explore/' + folder.path if folder.has_sub else '/folder/' + folder.path }}" class="grid-item folder-card-in-grid">
                    <div class="char-cover">
                        {% if folder.has_img and folder.cover %}
                            <img src="/media/{{ folder.cover }}" loading="lazy" onload="this.classList.add('loaded')">
                        {% elif folder.count > 0 %}
                            <div class="video-placeholder-cover">
                                <span>ğŸ¬<br><span style="font-size: 0.8em;">Video/GIF</span></span>
                            </div>
                        {% endif %}
                        <div class="char-overlay"></div>
                        {% if folder.has_sub %}
                            <div class="mobile-folder-hint">ğŸ“‚</div>
                        {% endif %}
                    </div>
                    <div class="char-info">
                        <div class="char-name">{{ folder.name }}</div>
                        <div class="char-count">{{ folder.count }} é¡¹å†…å®¹</div>
                    </div>
                </a>
            {% endfor %}
        {% endif %}
        <template x-for="(file, index) in items" :key="index">
            <div class="grid-item" @click="openModal(index)">
                <template x-if="isImage(file)">
                    <img :src="'/media/' + file" loading="lazy" @load="$el.classList.add('loaded')">
                </template>
                <template x-if="isVideo(file)">
                    <video :src="'/media/' + file" muted loop playsinline
                           onmouseover="this.play()" onmouseout="this.pause()"
                           onloadeddata="this.classList.add('loaded')"></video>
                </template>

                <a :href="getFolderLink(file)"
                   class="grid-folder-btn"
                   x-show="!isFolderView && hasFolder(file)"
                   @click.stop>
                    ğŸ“‚ æ‰“å¼€å›¾é›†
                </a>

                <a :href="getFolderLink(file)"
                   class="mobile-jump-btn"
                   x-show="!isFolderView && hasFolder(file)"
                   @click.stop> ğŸ“‚
                </a>
            </div>
        </template>

        <div class="loader-trigger" x-intersect="typeof loadMore === 'function' && loadMore()">
            <span x-show="loading">â³ åŠ è½½ä¸­...</span>
            <span x-show="!hasMore && items.length > 0">--- End ---</span>
        </div>
    </div>

    <div class="modal" 
         x-show="modalOpen" 
         x-transition.opacity
         @keydown.escape.window="closeModal()"
         @keydown.arrow-right.window="next()"
         @keydown.arrow-left.window="prev()"
         @click="closeModal()">
         
        <div class="modal-close" @click.stop="closeModal()">&times;</div>
        
        <div style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">
            <template x-if="modalOpen && currentItem">
                <div class="modal-media-container" @click.stop>
                    <div class="nav-hitbox prev-hitbox" @click.stop="prev()"></div>
                    <div class="nav-hitbox next-hitbox" @click.stop="next()"></div>

                    <template x-if="isImage(currentItem)">
                        <img :src="'/media/' + currentItem" class="modal-content">
                    </template>
                    <template x-if="isVideo(currentItem)">
                        <video :src="'/media/' + currentItem" class="modal-content" controls autoplay></video>
                    </template>
                </div>
            </template>
        </div>
    </div>
</div>

<style>
.nav a.folder-btn {
    background-color: #005a9e;
    color: #fff;
    font-weight: bold;
}
.nav a {
    color: #eee;
    text-decoration: none;
    padding: 0 15px;
    font-size: 14px;
    height: 100%;
    display: flex;
    align-items: center;
    white-space: nowrap;
    background-color: transparent;
    transition: background-color 0.2s;
}
/* æ··æ’æ¨¡å¼ä¸‹çš„æ–‡ä»¶å¤¹å¡ç‰‡æ ·å¼ */
.folder-card-in-grid {
	text-decoration: none; display: block;
	border-radius: 4px; border: 1px solid #333;
	transition: transform 0.2s, border-color 0.2s;
}
.folder-card-in-grid:hover {
	transform: translateY(-5px); border-color: #0078d4;
	box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 10;
}
.folder-card-in-grid .char-cover { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
.folder-card-in-grid .char-cover img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; }
.folder-card-in-grid .char-cover img.loaded { opacity: 1; }
.folder-card-in-grid .char-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); z-index: 1; }
.folder-card-in-grid .char-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 12px; box-sizing: border-box; z-index: 2; }
.folder-card-in-grid .char-name { color: #fff; font-weight: bold; font-size: 1.1em; text-shadow: 0 1px 2px rgba(0,0,0,1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
.folder-card-in-grid .char-count { color: #ccc; font-size: 0.85em; }
.folder-card-in-grid .mobile-folder-hint { position: absolute; bottom: 60px; right: 10px; width: 32px; height: 32px; background-color: rgba(0, 0, 0, 0.65); backdrop-filter: blur(4px); border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; z-index: 20; }
.folder-card-in-grid .video-placeholder-cover { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: #2a2a2a; color: #888; text-align: center; font-size: 1.2em; line-height: 1.2; }

@media (max-width: 768px) {
	.folder-card-in-grid .char-info { padding: 6px !important; }
	.folder-card-in-grid .char-name { font-size: 0.8em !important; margin-bottom: 2px !important; }
	.folder-card-in-grid .char-count { font-size: 0.7em !important; }
	.folder-card-in-grid .mobile-folder-hint { width: 24px; height: 24px; font-size: 14px; bottom: 45px; right: 4px; }
}
</style>

<script>
function galleryApp(apiUrl) {
    // é¢„å¤„ç†ï¼šç¡®ä¿ä¼ å…¥çš„ URL å­—ç¬¦ä¸²ä¸å¸¦å¤šä½™çš„å¼•å·ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
    const cleanApiUrl = typeof apiUrl === 'string' ? apiUrl.replace(/^["']|["']$/g, '') : '';

    return {
        items: [],
        page: 1,
        loading: false,
        hasMore: true,
        modalOpen: false,
        currentIndex: 0,
        baseApiUrl: cleanApiUrl,
        isFolderView: cleanApiUrl.includes('folder_data'),
        seed: (cleanApiUrl.includes('/api/images') || cleanApiUrl.includes('/api/videos')) ? Date.now() : null,
        
        showNav: true,
        lastScrollY: 0,

        handleScroll() {
            if (this.modalOpen) return;
            const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;
            this.showNav = !(currentScrollY > this.lastScrollY && currentScrollY > 50);
            this.lastScrollY = currentScrollY;
        },

        async loadMore() {
            if (this.loading || !this.hasMore) return;
            this.loading = true;
            try {
                const sep = this.baseApiUrl.includes('?') ? '&' : '?';
                let url = `${this.baseApiUrl}${sep}page=${this.page}`;
                if (this.seed) url += `&seed=${this.seed}`;
                
                const res = await fetch(url);
                if (!res.ok) throw new Error('Network response was not ok');
                const data = await res.json();
                
                if (data.files && data.files.length > 0) {
                    this.items.push(...data.files);
                    this.page++;
                    this.hasMore = data.has_more;
                } else {
                    this.hasMore = false;
                }
            } catch (e) {
                console.error("Gallery Load Error:", e);
                this.hasMore = false;
            } finally {
                this.loading = false;
            }
        },
		goBack() {
            // å¦‚æœæœ‰å†å²è®°å½•ï¼Œå¹¶ä¸”ä¸Šä¸€ä¸ªé¡µé¢æ˜¯æœ¬ç«™ï¼ˆé˜²æ­¢è·³è½¬åˆ°å¤–éƒ¨ç½‘ç«™ï¼‰
            if (window.history.length > 1 && document.referrer.includes(window.location.host)) {
                window.history.back(); // å®Œç¾é€€å›ä¸Šä¸€ä¸ªé¡µé¢ï¼Œä¿ç•™æ»šåŠ¨ä½ç½®
            } else {
                // å¦‚æœæ˜¯æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼Œæ²¡æœ‰å†å²è®°å½•ï¼Œæä¾›å…œåº•è·³è½¬
                if (this.baseApiUrl.includes('folder_data')) {
                    window.location.href = '/explore'; 
                } else if (window.location.search.includes('folder=')) {
                    // [æ ¸å¿ƒæ–°å¢] å¦‚æœæ˜¯æœç´¢ç»“æœçš„æ–‡ä»¶å¤¹å†…ï¼Œå…œåº•é€€å›å¯¹åº”çš„æœç´¢æ–‡ä»¶å¤¹é¡µ
                    const urlParams = new URLSearchParams(window.location.search);
                    const q = urlParams.get('q') || '';
                    window.location.href = '/search/folders?q=' + encodeURIComponent(q);
                } else {
                    window.location.href = '/';
                }
            }
        },

        openModal(idx) {
            this.currentIndex = idx;
            this.modalOpen = true;
            this.showNav = false;
            document.body.style.overflow = 'hidden';
        },
        closeModal() {
            this.modalOpen = false;
            this.showNav = true;
            document.body.style.overflow = '';
        },
        get currentItem() { return this.items[this.currentIndex]; },
        
        next() {
            if (this.currentIndex < this.items.length - 1) {
                this.currentIndex++;
            } else if (this.hasMore) {
                this.loadMore().then(() => {
                    if (this.currentIndex < this.items.length - 1) this.currentIndex++;
                });
            }
        },
        prev() { 
            if (this.currentIndex > 0) this.currentIndex--; 
        },
        isImage(p) { return p ? /\.(png|jpg|jpeg|webp|bmp)$/i.test(p) : false; },
        isVideo(p) { return p ? /\.(mp4|webm|mov|mkv|gif)$/i.test(p) : false; },
        hasFolder(p) { return p && (p.includes('/') || p.includes('\\')); },
		getFolderLink(p) {
            if (!p) return '#';
            const norm = p.replace(/\\/g, '/');
            const lastSlash = norm.lastIndexOf('/');
            return lastSlash !== -1 ? '/folder/' + encodeURIComponent(norm.substring(0, lastSlash)) : '#';
        },
        
        // ã€æ–°å¢ã€‘ï¼šæ™ºèƒ½åˆ‡æ¢åˆ°æ–‡ä»¶å¤¹æ¨¡å¼ï¼Œä¿ç•™ä½œè€…ç›®å½•è¿‡æ»¤
        toggleFolderMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const q = urlParams.get('q');
            const folder = urlParams.get('folder');

            if (q) {
                let targetUrl = `/search/folders?q=${encodeURIComponent(q)}`;
                // å¦‚æœå½“å‰åœ¨ç‰¹å®šä½œè€…ç›®å½•ä¸‹æœç´¢ï¼Œå¿…é¡»å¸¦ä¸Š folder å‚æ•°
                if (folder) {
                    targetUrl += `&folder=${encodeURIComponent(folder)}`;
                }
                window.location.replace(targetUrl);
            } else {
                window.location.replace('/tags');
            }
        }
    }
}
</script>
{% endblock %}