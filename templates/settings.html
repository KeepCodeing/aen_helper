{% extends "base.html" %}

{% block title %}è®¾ç½®ä¸ç›¸å†Œç®¡ç†{% endblock %}

{% block content %}
<div x-data="settingsApp()" x-init="initApp()" x-cloak class="settings-container">

    <div class="nav">
        <div class="nav-group left">
            <div class="nav-title">âš™ï¸ ç³»ç»Ÿè®¾ç½®ä¸ç›¸å†Œå¤§å…</div>
        </div>
    </div>

    <div class="settings-layout">
        
        <div class="panel albums-panel">
            <h2 class="panel-title">ğŸ“‚ æˆ‘çš„ä¾¿æºç›¸å†Œ</h2>
            <p class="panel-desc">é€‰æ‹©ä¸€ä¸ªå·²å®Œæˆæ‰“æ ‡çš„ç›¸å†Œå¹¶æŒ‚è½½æµè§ˆ</p>

            <div class="album-grid">
                <template x-if="albums.length === 0">
                    <div class="empty-state">
                        æš‚æ— ç›¸å†Œï¼Œè¯·åœ¨å³ä¾§è¾“å…¥ç›®å½•è¿›è¡Œ AI æ‰“æ ‡
                    </div>
                </template>

                <template x-for="album in albums" :key="album">
                    <div class="album-card">
                        <div class="album-icon">ğŸ—‚ï¸</div>
                        <div class="album-info">
                            <div class="album-path" x-text="album" :title="album"></div>
                        </div>
                        <div class="album-actions">
                            <button class="mount-btn" @click="mountAlbum(album)" :disabled="mounting === album">
                                <span x-show="mounting !== album">è¿›å…¥å›¾åº“ â”</span>
                                <span x-show="mounting === album">åŠ è½½ä¸­...</span>
                            </button>
                            <button class="delete-btn" @click="removeAlbum(album)" title="ä»åˆ—è¡¨ä¸­ç§»é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div class="panel tagger-panel">
            <h2 class="panel-title">âœ¨ æ–°å¢ç›¸å†Œ (AI æ™ºèƒ½æ‰“æ ‡)</h2>
            <p class="panel-desc">è¾“å…¥æœ¬åœ°æ–‡ä»¶å¤¹çš„ç»å¯¹è·¯å¾„ï¼Œå¼€å§‹åå°æ‰«æä¸è¯†åˆ«</p>

            <div class="input-group">
                <input type="text" 
                       x-model="newAlbumPath" 
                       class="path-input" 
                       placeholder="ä¾‹å¦‚: E:\rise and shine\2D\XP\Splus\AI"
                       :disabled="status.is_running">
                
                <button class="start-btn" 
                        @click="startTagger()" 
                        :disabled="status.is_running || !newAlbumPath.trim()">
                    <span x-show="!status.is_running">ğŸš€ å¼€å§‹æ‰“æ ‡</span>
                    <span x-show="status.is_running">â¸ï¸ ä»»åŠ¡è¿è¡Œä¸­</span>
                </button>
            </div>

            <div class="terminal-box">
                <div class="terminal-header">
                    <span class="dot red"></span>
                    <span class="dot yellow"></span>
                    <span class="dot green"></span>
                    <span class="terminal-title">Tagger Console</span>
                </div>
                <div class="terminal-body" :class="{ 'active': status.is_running }">
                    <template x-if="!status.is_running && !status.output">
                        <div class="terminal-line" style="color: #666;">Waiting for task...</div>
                    </template>
                    
                    <template x-if="status.target_dir">
                        <div class="terminal-line info">
                            > Target: <span x-text="status.target_dir"></span>
                        </div>
                    </template>

                    <div class="terminal-line output" x-text="status.output || '...'"></div>
                    
                    <template x-if="status.is_running">
                        <div class="spinner-line">
                            <span class="spinner"></span> Processing...
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="hint-text">
                ğŸ’¡ æç¤ºï¼šæ‰“æ ‡è¿‡ç¨‹å¯èƒ½éœ€è¦æ•°åˆ†é’Ÿè‡³æ•°å°æ—¶ã€‚å…³é—­æ­¤ç½‘é¡µä¸ä¼šä¸­æ–­åå°ä»»åŠ¡ï¼Œæ‚¨å¯ä»¥éšæ—¶åˆ·æ–°æŸ¥çœ‹è¿›åº¦ã€‚
            </div>
        </div>

    </div>
</div>

<style>
    /* é¡µé¢åŸºç¡€å¸ƒå±€ */
    .settings-container { padding-top: 60px; min-height: 100vh; background: #121212; color: #eee; }
    .settings-layout { display: flex; gap: 30px; padding: 30px; max-width: 1400px; margin: 0 auto; flex-wrap: wrap; }
    
    /* é¢æ¿é€šç”¨æ ·å¼ */
    .panel { background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 25px; flex: 1; min-width: 350px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
    .panel-title { margin: 0 0 8px 0; font-size: 1.4em; color: #fff; display: flex; align-items: center; gap: 8px; }
    .panel-desc { color: #888; font-size: 0.9em; margin-bottom: 25px; }

    /* å·¦ä¾§ç›¸å†Œåˆ—è¡¨ */
    .album-grid { display: flex; flex-direction: column; gap: 15px; }
    .album-card { display: flex; align-items: center; background: #222; border: 1px solid #444; border-radius: 8px; padding: 15px; transition: transform 0.2s, border-color 0.2s; }
    .album-card:hover { border-color: #0078d4; transform: translateX(5px); }
    .album-icon { font-size: 24px; margin-right: 15px; }
    .album-info { flex: 1; overflow: hidden; }
    .album-path { font-family: monospace; font-size: 1.1em; color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; direction: rtl; text-align: left; }
    .empty-state { text-align: center; padding: 40px 20px; color: #666; background: #1a1a1a; border: 2px dashed #333; border-radius: 8px; }

    /* æŒ‰é’® */
    .mount-btn { background: #0078d4; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s; white-space: nowrap; margin-left: 15px; }
    .mount-btn:hover:not(:disabled) { background: #0063b1; }
    .mount-btn:disabled { background: #444; color: #888; cursor: not-allowed; }

    /* å³ä¾§è¾“å…¥ä¸ç»ˆç«¯ */
    .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
    .path-input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 12px 15px; border-radius: 6px; font-size: 1em; font-family: monospace; transition: border-color 0.2s; }
    .path-input:focus { border-color: #0078d4; outline: none; }
    .path-input:disabled { opacity: 0.6; cursor: not-allowed; }
    .start-btn { background: #107c10; color: #fff; border: none; padding: 0 24px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.2s; white-space: nowrap; }
    .start-btn:hover:not(:disabled) { background: #0b5a0b; }
    .start-btn:disabled { background: #444; color: #888; cursor: not-allowed; }

    /* é…·ç‚«çš„ç»ˆç«¯è¾“å‡ºæ¡† */
    .terminal-box { background: #0c0c0c; border-radius: 8px; border: 1px solid #333; overflow: hidden; margin-bottom: 15px; }
    .terminal-header { background: #1e1e1e; padding: 8px 12px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #333; }
    .dot { width: 12px; height: 12px; border-radius: 50%; }
    .dot.red { background: #ff5f56; }
    .dot.yellow { background: #ffbd2e; }
    .dot.green { background: #27c93f; }
    .terminal-title { color: #888; font-size: 0.8em; margin-left: auto; font-family: monospace; }
    
    .terminal-body { padding: 15px; font-family: 'Consolas', 'Courier New', monospace; font-size: 0.9em; min-height: 120px; color: #ccc; line-height: 1.5; }
    .terminal-body.active { box-shadow: inset 0 0 20px rgba(0, 255, 0, 0.05); }
    .terminal-line.info { color: #0078d4; margin-bottom: 10px; }
    .terminal-line.output { color: #27c93f; word-wrap: break-word; }
    
    .spinner-line { display: flex; align-items: center; gap: 10px; margin-top: 15px; color: #888; font-size: 0.85em; }
    .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #444; border-top-color: #27c93f; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hint-text { color: #888; font-size: 0.85em; line-height: 1.4; }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
        .settings-layout { padding: 15px; flex-direction: column; }
        .input-group { flex-direction: column; }
        .start-btn { padding: 12px; }
        .album-card { flex-direction: column; align-items: stretch; text-align: center; gap: 10px; }
        .mount-btn { margin-left: 0; }
        .album-path { direction: ltr; }
    }
	
	.album-actions { display: flex; align-items: center; gap: 10px; margin-left: 15px; }
    .delete-btn { background: #444; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
    .delete-btn:hover { background: #d13438; }
</style>

<script>
function settingsApp() {
    return {
        albums: [],
        newAlbumPath: '',
        mounting: null,
        status: {
            is_running: false,
            target_dir: '',
            output: ''
        },
        pollInterval: null,

        initApp() {
            this.fetchAlbums();
            this.fetchStatus();
            
            // åªæœ‰å½“ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œæˆ–è€…æˆ‘ä»¬å¤„äºæœªçŸ¥çŠ¶æ€æ—¶ï¼Œæ‰é«˜é¢‘è½®è¯¢
            this.pollInterval = setInterval(() => {
                if (this.status.is_running || this.status.output === '') {
                    this.fetchStatus();
                }
            }, 1000); // 1ç§’åˆ·æ–°ä¸€æ¬¡è¿›åº¦
        },

        async fetchAlbums() {
            try {
                const res = await fetch('/api/albums');
                const data = await res.json();
                this.albums = data.albums || [];
            } catch (e) {
                console.error("Failed to load albums", e);
            }
        },

        async fetchStatus() {
            try {
                const res = await fetch('/api/tagger/status');
                const newStatus = await res.json();
                
                // å¦‚æœæ£€æµ‹åˆ°ä»»åŠ¡åˆšåˆšä»"è¿è¡Œä¸­"å˜æˆ"å·²åœæ­¢"ï¼Œè¯´æ˜æ‰“æ ‡å®Œæˆäº†ï¼Œåˆ·æ–°ç›¸å†Œåˆ—è¡¨
                if (this.status.is_running && !newStatus.is_running) {
                    this.fetchAlbums();
                }
                this.status = newStatus;
                
                // å¦‚æœä»»åŠ¡æ­£åœ¨è¿è¡Œï¼ŒæŠŠè¾“å…¥æ¡†æ¸…ç©ºå¹¶ç»‘å®šåˆ°æ­£åœ¨è¿è¡Œçš„ç›®å½•ä¸Š
                if (this.status.is_running) {
                    this.newAlbumPath = '';
                }
            } catch (e) {
                console.error("Failed to fetch status", e);
            }
        },

        async mountAlbum(path) {
            if (this.status.is_running) {
                alert("å½“å‰æœ‰æ‰“æ ‡ä»»åŠ¡æ­£åœ¨åå°è¿è¡Œï¼Œè¯·ç­‰å¾…ä»»åŠ¡ç»“æŸåå†æŒ‚è½½æ–°å›¾åº“ä»¥é˜²æ­¢æ•°æ®åº“å†²çªã€‚");
                return;
            }

            this.mounting = path;
            try {
                const res = await fetch('/api/mount', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const data = await res.json();
                
                if (data.success) {
                    // æŒ‚è½½æˆåŠŸï¼Œè·³å›é¦–é¡µçœ‹å›¾ï¼
                    window.location.href = '/';
                } else {
                    alert("æŒ‚è½½å¤±è´¥: " + data.message);
                    this.mounting = null;
                }
            } catch (e) {
                alert("ç½‘ç»œé”™è¯¯");
                this.mounting = null;
            }
        },

        async startTagger() {
            const path = this.newAlbumPath.trim();
            if (!path) return;

            try {
                const res = await fetch('/api/tagger/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const data = await res.json();
                
                if (data.success) {
                    this.newAlbumPath = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                    this.fetchStatus();     // ç«‹å³æŠ“å–ä¸€æ¬¡çŠ¶æ€ç‚¹äº®ç»ˆç«¯
                } else {
                    alert("æ— æ³•å¯åŠ¨ä»»åŠ¡: " + data.message);
                }
            } catch (e) {
                alert("è¯·æ±‚å¤±è´¥");
            }
        },
		
		async removeAlbum(path) {
            // å¼¹å‡ºåŸç”Ÿçš„ç¡®è®¤æç¤ºæ¡†
            if (!confirm(`ç¡®å®šè¦ä»åˆ—è¡¨ä¸­ç§»é™¤ç›¸å†Œå—ï¼Ÿ\n\nè·¯å¾„: ${path}\n\næ³¨æ„ï¼šè¿™åªä¼šå°†å®ƒä»åˆ—è¡¨éšè—ï¼Œä¸ä¼šåˆ é™¤æ‚¨çš„ç‰©ç†å›¾ç‰‡å’Œæ•°æ®åº“æ–‡ä»¶ã€‚`)) {
                return;
            }

            try {
                const res = await fetch('/api/albums', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                const data = await res.json();
                
                if (data.success) {
                    this.fetchAlbums(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert("ç§»é™¤å¤±è´¥: " + data.message);
                }
            } catch (e) {
                alert("ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•ç§»é™¤");
            }
        }
    }
}
</script>
{% endblock %}