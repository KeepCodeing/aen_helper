{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div x-data="exploreApp()" @scroll.window="handleScroll()" x-cloak>

    <div class="nav" :class="{ 'nav-hidden': !showNav }">
        <div class="nav-group left">
            {% if current_path %}
                {% if parent_path %}
                    <a href="/explore/{{ parent_url_path }}">â¬… è¿”å›ä¸Šä¸€çº§</a>
                {% else %}
                    <a href="/explore">â¬… è¿”å›æ ¹ç›®å½•</a>
                {% endif %}
            {% else %}
                <a href="/">ğŸ  é¦–é¡µ</a>				
            {% endif %}
            <div class="nav-title" title="{{ page_title }}">{{ page_title }}</div>
			<span style="color: #444;">|</span>
			<a href="/grid">å›¾ç‰‡</a>
			<a href="/videos">è§†é¢‘</a>
			<a href="/tags">æ ‡ç­¾</a>
        </div>
        
        <div class="nav-group right">
            {% if current_path %}
            <div class="filter-bar">
                <div class="search-wrapper">
                    <input type="text" 
                           class="search-input" 
                           placeholder="åœ¨æ­¤ç›®å½•ä¸‹æœç´¢..." 
                           x-model="searchQuery"
                           @input="handleInput()"
                           @keydown.arrow-down.prevent="navigateSuggestions(1)"
                           @keydown.arrow-up.prevent="navigateSuggestions(-1)"
                           @keydown.enter.prevent="handleEnter()"
                           @keydown.escape.prevent="suggestions = []; selectedIndex = -1"
                           id="searchInput">
                    
                    <div class="autocomplete-list" 
                         x-show="suggestions.length > 0" 
                         @click.outside="suggestions = []; selectedIndex = -1">
                        <template x-for="(item, index) in suggestions" :key="index">
                            <div class="suggestion-item" 
                                 :class="{ 'active': selectedIndex === index }"
                                 @click="selectSuggestion(item)"
                                 @mouseover="selectedIndex = index">
                                <span x-text="item.name"></span>
                                <span class="count" x-text="item.count"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <button class="search-btn" @click="performSearch()">ğŸ” æœç´¢</button>
            </div>
            {% endif %}
		</div>
	</div>

    <div class="grid-container char-grid" style="padding-top: 60px;">
        {% for folder in folders %}
            <a href="{{ '/explore/' + folder.url_path if folder.has_sub else '/folder/' + folder.url_path }}" class="char-card">
                
                <div class="char-cover">
                    {% if folder.has_img and folder.cover %}
                        <img src="/media/{{ folder.cover | replace('#', '%23') | replace('?', '%3F') }}" loading="lazy" onload="this.classList.add('loaded')">
                    {% elif folder.count > 0 %}
                        <div class="video-placeholder-cover">
                            <span>ğŸ¬<br><span style="font-size: 0.8em;">Video/GIF</span></span>
                        </div>
                    {% endif %}

                    <div class="char-overlay"></div>
                    
                    {% if folder.has_sub %}
                        <div class="mobile-folder-hint">ğŸ“‚</div>
                    {% endif %}
                </div>
                
                <div class="char-info">
                    <div class="char-name">{{ folder.name }}</div>
                    <div class="char-count">{{ folder.count }} é¡¹å†…å®¹</div>
                </div>
            </a>
        {% endfor %}
        
        {% if not folders %}
            <div class="loader-trigger" style="grid-column: 1 / -1; text-align: center; margin-top: 50px;">
                <span style="color: #666;">ç›®å½•ä¸ºç©ºæˆ–åªæœ‰é›¶æ•£å›¾ç‰‡</span>
            </div>
        {% endif %}
    </div>

</div>

<style>
    /* æ ¸å¿ƒç½‘æ ¼æ ·å¼ */
    .char-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        padding: 20px;
    }
    .char-card {
        position: relative; display: block; aspect-ratio: 2 / 3; border-radius: 8px; overflow: hidden;
        text-decoration: none; background: #1a1a1a; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #333;
    }
    .char-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); border-color: #666; }
    
    .char-cover { width: 100%; height: 100%; position: relative; }
    .char-cover img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; }
    .char-cover img.loaded { opacity: 1; }
    .char-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); }
    
    .char-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 12px; box-sizing: border-box; }
    .char-name { color: #fff; font-weight: bold; font-size: 1.1em; text-shadow: 0 1px 2px rgba(0,0,0,1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
    .char-count { color: #ccc; font-size: 0.85em; }

    .mobile-folder-hint {
        position: absolute; bottom: 60px; right: 10px; width: 32px; height: 32px;
        background-color: rgba(0, 0, 0, 0.65); backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; font-size: 16px; z-index: 20;
    }
	
    .video-placeholder-cover {
        width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
        background-color: #2a2a2a; color: #888; text-align: center; font-size: 1.2em; line-height: 1.2;
    }

    /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 768px) {
        .char-grid {
            grid-template-columns: repeat(4, 1fr) !important;
            gap: 8px !important;
            padding: 60px 10px 20px 10px !important;
        }
        .char-info { padding: 6px !important; }
        .char-name { font-size: 0.75em !important; margin-bottom: 2px !important; }
        .char-count { font-size: 0.65em !important; }
        .mobile-folder-hint { width: 24px; height: 24px; font-size: 14px; bottom: 45px; right: 4px; }
    }
	
	/* æœç´¢æ æ ·å¼åŒæ­¥ tags.html */
    .filter-bar { display: flex; align-items: center; gap: 8px; margin-right: 10px; height: 32px; }
    .filter-select { 
        background-color: #333; color: #eee; border: 1px solid #555; 
        padding: 0 24px 0 10px; border-radius: 4px; font-size: 12px; height: 100%;
        appearance: none; 
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat; background-position: right 5px center; background-size: 12px;
    }
    .search-wrapper { position: relative; height: 100%; }
    .search-input { 
        background: #222; border: 1px solid #444; color: #fff; 
        padding: 0 10px; border-radius: 4px; width: 150px; height: 100%;
        transition: width 0.3s; font-size: 13px;
    }
    .search-input:focus { width: 220px; border-color: #0078d4; outline: none; }
	
    /* æœç´¢æŒ‰é’®ç¾åŒ– */
    .search-btn {
        height: 100%; padding: 0 16px; background-color: #0078d4; color: white; border: none;
        border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;
        transition: background 0.2s, transform 0.1s; display: flex; align-items: center; gap: 6px;
        box-shadow: none !important;
    }
    .search-btn:hover { background-color: #0063b1; }
    .search-btn:active { transform: scale(0.96); }
    
    .autocomplete-list { 
        position: absolute; top: 110%; left: 0; min-width: 100%; 
        background: #1e1e1e; border: 1px solid #444; border-radius: 4px; 
        max-height: 250px; overflow-y: auto; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); 
    }
    .suggestion-item { 
        padding: 8px 12px; border-bottom: 1px solid #333; cursor: pointer; 
        display: flex; justify-content: space-between; color: #ddd; font-size: 12px;
    }
    .suggestion-item.active, .suggestion-item:hover { background: #0078d4; color: #fff; }
    .suggestion-item .count { color: #666; font-size: 0.9em; }
</style>

<script>
function exploreApp() {
    return {
        showNav: true,
        lastScrollY: 0,
        searchQuery: '',
        searchType: 'tag',
        currentPath: '{{ current_path }}',
        allTags: [],
        suggestions: [],
        selectedIndex: -1,

        init() {
            this.loadTagsCache();
        },

        async loadTagsCache() {
            try {
                const res = await fetch('/api/tags/all');
                this.allTags = await res.json();
            } catch(e) { console.error("Tags cache error", e); }
        },

        handleInput() {
            this.selectedIndex = -1;
            const val = this.searchQuery;
            const parts = val.split(',');
            const lastPart = parts[parts.length - 1].trim().toLowerCase();

            if (lastPart.length < 1) {
                this.suggestions = [];
                return;
            }
            this.suggestions = this.allTags
                .filter(t => t.name.toLowerCase().includes(lastPart))
                .slice(0, 10);
        },

        navigateSuggestions(direction) {
            if (this.suggestions.length === 0) return;
            this.selectedIndex += direction;
            if (this.selectedIndex < 0) this.selectedIndex = this.suggestions.length - 1;
            else if (this.selectedIndex >= this.suggestions.length) this.selectedIndex = 0;
            
            this.$nextTick(() => {
                const activeEl = document.querySelector('.suggestion-item.active');
                if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
            });
        },

        handleEnter() {
            if (this.suggestions.length > 0 && this.selectedIndex >= 0) {
                this.selectSuggestion(this.suggestions[this.selectedIndex]);
            } else {
                this.performSearch();
            }
        },

        selectSuggestion(item) {
            let current = this.searchQuery;
            const parts = current.split(',');
            
            const newTagName = (item.type === 'char') ? `char:${item.name.replace('char:', '')}` : item.name;
            
            // æ›¿æ¢æœ€åä¸€éƒ¨åˆ†å¹¶è¿½åŠ é€—å·å’Œç©ºæ ¼ï¼Œå®ç°å’Œ tags.html ä¸€è‡´çš„è¿ç»­è¡¥å…¨ä½“éªŒ
            parts[parts.length - 1] = ' ' + newTagName; 
            this.searchQuery = parts.join(',') + ', ';
            
            this.suggestions = [];
            this.selectedIndex = -1;
            
            this.$nextTick(() => {
                const input = document.getElementById('searchInput');
                if (input) {
                    input.focus();
                    const len = input.value.length;
                    input.setSelectionRange(len, len);
                }
            });
        },

        performSearch() {
            const queryRaw = this.searchQuery.trim().replace(/,$/, ''); 
            if (!queryRaw) return;
            
            let query = queryRaw;
            // è‡ªåŠ¨ä¿®æ­£è§’è‰²å‰ç¼€é€»è¾‘
            if (this.searchType === 'char' && !query.startsWith('char:')) {
                query = 'char:' + query;
            }

            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šå°†é»˜è®¤è·³è½¬è·¯ç”±ä» /search æ”¹ä¸º /search/folders
            const url = `/search/folders?q=${encodeURIComponent(query)}&folder=${encodeURIComponent(this.currentPath)}`;
            window.location.href = url;
        },

        handleScroll() {
            const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;
            this.showNav = !(currentScrollY > this.lastScrollY && currentScrollY > 50);
            this.lastScrollY = currentScrollY;
        }
    }
}
</script>
{% endblock %}