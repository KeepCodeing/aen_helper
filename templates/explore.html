{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div x-data="exploreApp()" @scroll.window="handleScroll()" x-cloak>

    <div class="nav" :class="{ 'nav-hidden': !showNav }">
        <div class="nav-group left">
            {% if current_path %}
                {% if parent_path %}
                    <a href="/explore/{{ parent_url_path }}">â¬… è¿”å›ä¸Šä¸€çº§</a>
                {% else %}
                    <a href="/explore">â¬… è¿”å›æ ¹ç›®å½•</a>
                {% endif %}
            {% else %}
                <a href="/">ğŸ  é¦–é¡µ</a>				
            {% endif %}
            <div class="nav-title" title="{{ page_title }}">{{ page_title }}</div>
			<span style="color: #444;">|</span>
			<a href="/grid">å›¾ç‰‡</a>
			<a href="/videos">è§†é¢‘</a>
			<a href="/tags">æ ‡ç­¾</a>
        </div>
        
        <div class="nav-group right">
            {% if current_path %}
            <button class="mobile-search-toggle" 
                    @click="mobileSearchOpen = true; $nextTick(() => document.getElementById('searchInput').focus())" 
                    x-show="!mobileSearchOpen">
                ğŸ”
            </button>

            <div class="filter-bar" :class="{ 'mobile-open': mobileSearchOpen }" x-cloak>
                <div class="search-wrapper">
                    <input type="text" 
                           class="search-input" 
                           placeholder="åœ¨æ­¤ç›®å½•ä¸‹æœç´¢..." 
                           x-model="searchQuery"
                           @input="handleInput()"
                           @keydown.arrow-down.prevent="navigateSuggestions(1)"
                           @keydown.arrow-up.prevent="navigateSuggestions(-1)"
                           @keydown.enter.prevent="handleEnter()"
                           @keydown.escape.prevent="suggestions = []; selectedIndex = -1; mobileSearchOpen = false"
                           id="searchInput">
                    
                    <div class="autocomplete-list" 
                         x-show="suggestions.length > 0" 
                         @click.outside="suggestions = []; selectedIndex = -1">
                        <template x-for="(item, index) in suggestions" :key="index">
                            <div class="suggestion-item" 
                                 :class="{ 'active': selectedIndex === index }"
                                 @click="selectSuggestion(item)"
                                 @mouseover="selectedIndex = index">
                                <span x-text="item.name"></span>
                                <span class="count" x-text="item.count"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <button class="search-btn" @click="performSearch()">ğŸ”<span class="desktop-text"> æœç´¢</span></button>
                <button class="cancel-search-btn" @click="mobileSearchOpen = false">å–æ¶ˆ</button>
            </div>
            {% endif %}
		</div>
	</div>

    <div class="grid-container char-grid" style="padding-top: 60px;">
        {% for folder in folders %}
            <a href="{{ '/explore/' + folder.url_path if folder.has_sub else '/folder/' + folder.url_path }}" class="char-card">
                
                <div class="char-cover">
                    {% if folder.has_img and folder.cover %}
                        <img src="/media/{{ folder.cover | replace('#', '%23') | replace('?', '%3F') }}" loading="lazy" onload="this.classList.add('loaded')">
                    {% elif folder.count > 0 %}
                        <div class="video-placeholder-cover">
                            <span>ğŸ¬<br><span style="font-size: 0.8em;">Video/GIF</span></span>
                        </div>
                    {% endif %}

                    <div class="char-overlay"></div>
                    
                    {% if folder.has_sub %}
                        <div class="mobile-folder-hint">ğŸ“‚</div>
                    {% endif %}
                </div>
                
                <div class="char-info">
                    <div class="char-name">{{ folder.name }}</div>
                    <div class="char-count">{{ folder.count }} é¡¹å†…å®¹</div>
                </div>
            </a>
        {% endfor %}
        
        {% if not folders %}
            <div class="loader-trigger" style="grid-column: 1 / -1; text-align: center; margin-top: 50px;">
                <span style="color: #666;">ç›®å½•ä¸ºç©ºæˆ–åªæœ‰é›¶æ•£å›¾ç‰‡</span>
            </div>
        {% endif %}
    </div>

</div>

<style>
    /* æ ¸å¿ƒç½‘æ ¼æ ·å¼ */
    .char-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        padding: 20px;
    }
    .char-card {
        position: relative; display: block; aspect-ratio: 2 / 3; border-radius: 8px; overflow: hidden;
        text-decoration: none; background: #1a1a1a; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #333;
    }
    .char-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); border-color: #666; }
    
    .char-cover { width: 100%; height: 100%; position: relative; }
    .char-cover img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; }
    .char-cover img.loaded { opacity: 1; }
    .char-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); }
    
    .char-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 12px; box-sizing: border-box; }
    .char-name { color: #fff; font-weight: bold; font-size: 1.1em; text-shadow: 0 1px 2px rgba(0,0,0,1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
    .char-count { color: #ccc; font-size: 0.85em; }

    .mobile-folder-hint {
        position: absolute; bottom: 60px; right: 10px; width: 32px; height: 32px;
        background-color: rgba(0, 0, 0, 0.65); backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; font-size: 16px; z-index: 20;
    }
	
    .video-placeholder-cover {
        width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
        background-color: #2a2a2a; color: #888; text-align: center; font-size: 1.2em; line-height: 1.2;
    }

    /* =========================================
       æœç´¢æ åŸºç¡€æ ·å¼ (PCç«¯)
       ========================================= */
    .filter-bar { display: flex; align-items: center; gap: 8px; margin-right: 10px; height: 32px; }
    .search-wrapper { position: relative; height: 100%; }
    .search-input { 
        background: #222; border: 1px solid #444; color: #fff; 
        padding: 0 10px; border-radius: 4px; width: 150px; height: 100%;
        transition: width 0.3s; font-size: 13px; box-sizing: border-box;
    }
    .search-input:focus { width: 220px; border-color: #0078d4; outline: none; }
    
    .search-btn {
        height: 100%; padding: 0 16px; background-color: #0078d4; color: white; border: none;
        border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;
        transition: background 0.2s, transform 0.1s; display: flex; align-items: center; gap: 6px;
        box-shadow: none !important;
    }
    .search-btn:hover { background-color: #0063b1; }
    .search-btn:active { transform: scale(0.96); }

    /* å»ºè®®åˆ—è¡¨ */
    .autocomplete-list { 
        position: absolute; top: 110%; left: 0; min-width: 100%; 
        background: #1e1e1e; border: 1px solid #444; border-radius: 4px; 
        max-height: 250px; overflow-y: auto; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); 
    }
    .suggestion-item { 
        padding: 8px 12px; border-bottom: 1px solid #333; cursor: pointer; 
        display: flex; justify-content: space-between; color: #ddd; font-size: 12px;
    }
    .suggestion-item.active, .suggestion-item:hover { background: #0078d4; color: #fff; }
    .suggestion-item .count { color: #666; font-size: 0.9em; }

    /* éšè—ç§»åŠ¨ç«¯ä¸“å±æŒ‰é’® (PCç«¯é»˜è®¤ä¸æ˜¾ç¤º) */
    .mobile-search-toggle, .cancel-search-btn { display: none; }

    /* =========================================
       ç§»åŠ¨ç«¯ä¸“å±ä¼˜åŒ– (å¡ç‰‡å¸ƒå±€ + æœç´¢æŠ½å±‰)
       ========================================= */
    @media (max-width: 768px) {
        /* å¡ç‰‡é‡æ’ */
        .char-grid {
            grid-template-columns: repeat(4, 1fr) !important;
            gap: 8px !important;
            padding: 60px 10px 20px 10px !important;
        }
        .char-info { padding: 6px !important; }
        .char-name { font-size: 0.75em !important; margin-bottom: 2px !important; }
        .char-count { font-size: 0.65em !important; }
        .mobile-folder-hint { width: 24px; height: 24px; font-size: 14px; bottom: 45px; right: 4px; }
		
        /* å”¤é†’æŒ‰é’®ï¼šå¹³æ—¶å®‰é™åœ°å‘†åœ¨å³ä¸Šè§’ */
        .mobile-search-toggle {
            display: flex; align-items: center; justify-content: center;
            background: transparent; border: none; color: #fff;
            font-size: 18px; cursor: pointer; padding: 0 10px; height: 100%;
        }

        /* é»˜è®¤éšè—åŸæ¥çš„æ¨ªæ’æœç´¢æ  */
        .filter-bar { display: none; }

        /* 3. æ ¸å¿ƒï¼šæŠ½å±‰å±•å¼€æ—¶çš„æ ·å¼ */
        .filter-bar.mobile-open {
            display: flex; position: fixed;
            top: 0; left: 0; width: 100%; height: 60px; /* æŠ½å±‰æ€»é«˜åº¦ */
            background: #1a1a1a; z-index: 2000;
            padding: 0 15px; box-sizing: border-box;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            animation: slideDown 0.2s ease-out forwards;
            gap: 12px; margin: 0 !important;
            
            /* ã€æ ¸å¿ƒä¿®å¤1ã€‘ï¼šå‚ç›´å±…ä¸­ï¼Œç»å¯¹ä¸èƒ½æ‹‰ä¼¸ */
            align-items: center; 
            /* ã€æ ¸å¿ƒä¿®å¤2ã€‘ï¼šæ°´å¹³å±…ä¸­å¯¹é½ï¼Œè®©æœç´¢æ¡†ä¸è¦å¤ªå®½ */
            justify-content: center; 
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        /* 4. æŠ½å±‰å†…çš„è¾“å…¥æ¡†æ’ç‰ˆ */
        .filter-bar.mobile-open .search-wrapper { 
            flex: 1; 
            max-width: 240px; /* ã€æ ¸å¿ƒä¿®å¤3ã€‘ï¼šé™åˆ¶æœç´¢æ¡†æœ€å¤§å®½åº¦ï¼Œä¸å†å‚»å¤§é»‘ç²— */
            height: 36px;     /* è®¾å®šç§»åŠ¨ç«¯èˆ’é€‚çš„å›ºå®šé«˜åº¦ */
        }
        .filter-bar.mobile-open .search-input { 
            width: 100%; 
            height: 100%; 
            padding: 0 16px; 
            border-radius: 18px; /* æ”¹ä¸ºèƒ¶å›Šåœ†è§’ï¼Œåœ¨æ‰‹æœºä¸Šæ›´å¥½çœ‹ */
        }
        
        .desktop-text { display: none; }
        
        /* 5. æœç´¢æŒ‰é’® */
        .filter-bar.mobile-open .search-btn { 
            height: 36px;   /* ä¸è¾“å…¥æ¡†ç­‰é«˜ */
            width: 44px;    /* å›ºå®šå®½åº¦ï¼Œå˜æˆä¸€ä¸ªæ­£æ–¹å½¢/åœ†è§’æŒ‰é’® */
            padding: 0; 
            border-radius: 18px; /* èƒ¶å›Šåœ†è§’ */
            flex-shrink: 0; /* ã€æ ¸å¿ƒä¿®å¤4ã€‘ï¼šç»å¯¹ä¸è®¸è¢«æŒ¤æ‰ï¼ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 6. å–æ¶ˆæŒ‰é’® */
        .cancel-search-btn {
            display: block; background: transparent; border: none;
            color: #ccc; font-size: 15px; 
            padding: 0 5px; white-space: nowrap; cursor: pointer;
            flex-shrink: 0; /* ã€æ ¸å¿ƒä¿®å¤5ã€‘ï¼šç»å¯¹ä¸è®¸è¢«æŒ¤æ‰ï¼ */
        }
        
        /* ä¿®å¤å»ºè®®åˆ—è¡¨åœ¨æŠ½å±‰ä¸‹çš„ä½ç½®å’Œå®½åº¦é—®é¢˜ */
        .autocomplete-list { 
            width: 100vw; 
            left: 50%; 
            transform: translateX(-50%); /* ä¿è¯è”æƒ³è¯åˆ—è¡¨åœ¨å±å¹•æ­£ä¸­é“ºæ»¡ */
            top: calc(100% + 12px); 
            border-radius: 0 0 8px 8px; 
        }
    }
</style>

<script>
function exploreApp() {
    return {
        showNav: true,
        lastScrollY: 0,
        searchQuery: '',
        searchType: 'tag',
        currentPath: '{{ current_path }}',
        allTags: [],
        suggestions: [],
        selectedIndex: -1,
        // æ§åˆ¶ç§»åŠ¨ç«¯æŠ½å±‰çš„çŠ¶æ€
        mobileSearchOpen: false,

        init() {
            this.loadTagsCache();
        },

        async loadTagsCache() {
            try {
                const res = await fetch('/api/tags/all');
                this.allTags = await res.json();
            } catch(e) { console.error("Tags cache error", e); }
        },

        handleInput() {
            this.selectedIndex = -1;
            const val = this.searchQuery;
            const parts = val.split(',');
            const lastPart = parts[parts.length - 1].trim().toLowerCase();

            if (lastPart.length < 1) {
                this.suggestions = [];
                return;
            }
            this.suggestions = this.allTags
                .filter(t => t.name.toLowerCase().includes(lastPart))
                .slice(0, 10);
        },

        navigateSuggestions(direction) {
            if (this.suggestions.length === 0) return;
            this.selectedIndex += direction;
            if (this.selectedIndex < 0) this.selectedIndex = this.suggestions.length - 1;
            else if (this.selectedIndex >= this.suggestions.length) this.selectedIndex = 0;
            
            this.$nextTick(() => {
                const activeEl = document.querySelector('.suggestion-item.active');
                if (activeEl) activeEl.scrollIntoView({ block: 'nearest' });
            });
        },

        handleEnter() {
            if (this.suggestions.length > 0 && this.selectedIndex >= 0) {
                this.selectSuggestion(this.suggestions[this.selectedIndex]);
            } else {
                this.performSearch();
            }
        },

        selectSuggestion(item) {
            let current = this.searchQuery;
            const parts = current.split(',');
            
            const newTagName = (item.type === 'char') ? `char:${item.name.replace('char:', '')}` : item.name;
            
            parts[parts.length - 1] = ' ' + newTagName; 
            this.searchQuery = parts.join(',') + ', ';
            
            this.suggestions = [];
            this.selectedIndex = -1;
            
            this.$nextTick(() => {
                const input = document.getElementById('searchInput');
                if (input) {
                    input.focus();
                    const len = input.value.length;
                    input.setSelectionRange(len, len);
                }
            });
        },

        performSearch() {
            const queryRaw = this.searchQuery.trim().replace(/,$/, ''); 
            if (!queryRaw) return;
            
            let query = queryRaw;
            if (this.searchType === 'char' && !query.startsWith('char:')) {
                query = 'char:' + query;
            }

            const url = `/search/folders?q=${encodeURIComponent(query)}&folder=${encodeURIComponent(this.currentPath)}`;
            window.location.href = url;
        },

        handleScroll() {
            const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;
            this.showNav = !(currentScrollY > this.lastScrollY && currentScrollY > 50);
            this.lastScrollY = currentScrollY;
        }
    }
}
</script>
{% endblock %}