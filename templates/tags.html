{% extends "base.html" %}

{% block title %}æœç´¢{% endblock %}

{% block content %}
<div x-data="tagsApp()" x-cloak>

    <div class="nav" :class="{ 'nav-hidden': !showNav }">
        <div class="nav-group left">
            <a href="/">ğŸ  é¦–é¡µ</a>
			<span style="color: #444;">|</span>
			<div class="nav-title">æœç´¢</div>
			<a href="/grid">ç½‘æ ¼</a>
            <a href="/videos">è§†é¢‘</a>
        </div>
        
        <div class="nav-group right">
			<button class="mobile-search-toggle" @click="mobileSearchOpen = !mobileSearchOpen; if(mobileSearchOpen) showNav = true;">
                <span x-text="mobileSearchOpen ? 'âœ–' : 'ğŸ”'"></span>
            </button>
            <div class="filter-bar" :class="{ 'mobile-open': mobileSearchOpen }">
                <select class="filter-select" x-model="searchType" title="æœç´¢ç›®æ ‡">
                    <option value="char">ğŸ‘¤ æœè§’è‰²</option>
                    <option value="tag">ğŸ·ï¸ æœæ ‡ç­¾</option>
                </select>
                
                <div class="search-wrapper">
                    <input type="text" 
                           class="search-input" 
                           placeholder="è¾“å…¥åç§°æˆ–æ ‡ç­¾..." 
                           x-model="searchQuery"
                           @input="handleInput()"
                           @keydown.arrow-down.prevent="navigateSuggestions(1)"
                           @keydown.arrow-up.prevent="navigateSuggestions(-1)"
                           @keydown.enter.prevent="handleEnter()"
                           @keydown.escape.prevent="suggestions = []; selectedIndex = -1"
                           id="searchInput">
                    
                    <div class="autocomplete-list" 
                         x-show="suggestions.length > 0" 
                         @click.outside="suggestions = []; selectedIndex = -1">
                        <template x-for="(item, index) in suggestions" :key="index">
                            <div class="suggestion-item" 
                                 :class="{ 'active': selectedIndex === index }"
                                 @click="selectSuggestion(item)"
                                 @mouseover="selectedIndex = index">
                                <span x-text="item.name"></span>
                                <span class="count" x-text="item.count"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <button class="search-btn" @click="performSearch()">
                    ğŸ” æœç´¢
                </button>
            </div>
        </div>
    </div>

    <div class="grid-container char-grid" @scroll.window="handleScroll()">
        
        <template x-for="char in characters" :key="char.name">
            <a :href="'/tags/folders/' + encodeURIComponent(char.name)" class="char-card">
               
                <div class="char-cover">
                    <img :src="'/media/' + char.cover" loading="lazy" :alt="char.name" @load="$el.classList.add('loaded')">
                    <div class="char-overlay"></div>
                </div>
                <div class="char-info">
                    <div class="char-name" x-text="char.name"></div>
                    <div class="char-count" x-text="char.count + ' å¼ '"></div>
                </div>
            </a>
        </template>

        <div class="loader-trigger" x-intersect="loadMore()">
            <span x-show="loading" class="loading-text">â³ æ­£åœ¨åŠ è½½...</span>
            <span x-show="!hasMore && characters.length > 0" class="end-text">--- åˆ°åº•äº† ---</span>
            <span x-show="!loading && characters.length === 0" class="empty-text">æœªæ‰¾åˆ°åŒ¹é…çš„è§’è‰²</span>
        </div>
    </div>

</div>

<style>
    /* --- æœç´¢æ å¸ƒå±€ä¼˜åŒ– --- */
    .filter-bar { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        margin-right: 10px; 
        height: 36px; /* ç»Ÿä¸€é«˜åº¦ */
    }

    /* ä¸‹æ‹‰æ¡†ç¾åŒ– */
    .filter-select { 
        background-color: #333; 
        color: #eee; 
        border: 1px solid #555; 
        padding: 0 28px 0 12px; /* ç»™å³ä¾§ç®­å¤´ç•™ç©º */
        border-radius: 6px; 
        font-size: 13px; 
        cursor: pointer; 
        height: 100%;
        outline: none;
        appearance: none; /* ç§»é™¤æµè§ˆå™¨é»˜è®¤ç®­å¤´ */
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 14px;
        transition: border-color 0.2s, background-color 0.2s;
    }
    .filter-select:hover { background-color: #444; border-color: #777; }
    .filter-select:focus { border-color: #0078d4; background-color: #222; }

    /* è¾“å…¥æ¡†å®¹å™¨ */
    .search-wrapper { position: relative; height: 100%; }
    
    /* è¾“å…¥æ¡†ç¾åŒ– */
    .search-input { 
        background: #222; 
        border: 1px solid #444; 
        color: #fff; 
        padding: 0 12px; 
        border-radius: 6px; 
        width: 200px; 
        height: 100%;
        box-sizing: border-box; /* ç¡®ä¿ padding ä¸æ’‘å¤§é«˜åº¦ */
        transition: width 0.3s, border-color 0.3s; 
        font-size: 14px;
    }
    .search-input:focus { 
        width: 300px; 
        background: #1a1a1a; 
        outline: none; 
        border-color: #0078d4; 
        box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
    }

    /* æœç´¢æŒ‰é’®ç¾åŒ– */
    .search-btn {
        height: 100%;
        padding: 0 16px;
        background-color: #0078d4;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
        display: flex;
        align-items: center;
        gap: 6px;
		box-shadow: none !important; /* ã€æ–°å¢ã€‘ï¼šå¼ºè¡Œå»é˜´å½± */
    }
    .search-btn:hover { background-color: #0063b1; }
    .search-btn:active { transform: scale(0.96); }

    /* è‡ªåŠ¨è¡¥å…¨ä¸‹æ‹‰ */
    .autocomplete-list { 
        position: absolute; 
        top: calc(100% + 4px); 
        left: 0; 
        min-width: 100%; /* è‡³å°‘å’Œè¾“å…¥æ¡†ä¸€æ ·å®½ */
        max-width: 400px; /* ä¹Ÿå¯ä»¥æ›´å®½ */
        background: #1e1e1e; 
        border: 1px solid #444;
        border-radius: 6px; 
        max-height: 300px; 
        overflow-y: auto; 
        z-index: 2000; 
        box-shadow: 0 8px 16px rgba(0,0,0,0.6); 
    }
    .suggestion-item { 
        padding: 10px 14px; 
        border-bottom: 1px solid #333; 
        cursor: pointer; 
        display: flex; 
        justify-content: space-between; 
        color: #ddd;
        font-size: 13px;
        transition: background 0.1s;
    }
    .suggestion-item:hover { background: #0078d4; color: #fff; }
    .suggestion-item:hover .count { color: #eee; } /* Hover æ—¶è®¡æ•°é¢œè‰²å˜æ·¡ */
    .suggestion-item:hover, .suggestion-item.active { background: #0078d4; color: #fff; }
    .suggestion-item:hover .count, .suggestion-item.active .count { color: #eee; }
	.suggestion-item .count { color: #666; font-size: 0.9em; }
	

    /* ç§»åŠ¨ç«¯é€‚é… */
    .mobile-search-toggle {
        display: none;
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        padding: 0 15px;
        cursor: pointer;
        height: 100%;
        outline: none;
        transition: transform 0.2s;
        box-shadow: none !important; /* ã€æ–°å¢ã€‘ï¼šå¼ºè¡Œå»é˜´å½± */
        -webkit-tap-highlight-color: transparent; /* ã€æ–°å¢ã€‘ï¼šå»æ‰ç§»åŠ¨ç«¯ç‚¹å‡»æ—¶çš„ç°è‰²åŠé€æ˜é«˜äº®å— */
    }
	
    .mobile-search-toggle:active { transform: scale(0.8); }

    /* --- ç§»åŠ¨ç«¯æ·±åº¦é€‚é… --- */
    @media (max-width: 768px) {
        .mobile-search-toggle { display: flex; align-items: center; justify-content: center; }
        
        .nav-group.right { flex-shrink: 0; box-shadow: none; }
        
        /* æ ¸å¿ƒé€»è¾‘ï¼šå°†æ•´ä¸ª Filter Bar å˜æˆéšè—çš„ä¸‹æ‹‰æŠ½å±‰ */
        .filter-bar {
            position: fixed;
            top: 50px; /* ç´§è´´å¯¼èˆªæ ä¸‹æ–¹ */
            left: 0;
            width: 100vw; /* å æ»¡å±å¹•å®½åº¦ */
            height: auto;
            background: #1a1a1a;
            padding: 15px;
            box-sizing: border-box;
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            gap: 12px;
            border-bottom: 1px solid #333;
			/* box-shadow: 0 10px 20px rgba(0,0,0,0.6); */
            
            /* æŠ½å±‰åŠ¨ç”»ï¼šé»˜è®¤è—åœ¨ä¸Šæ–¹ä¸”é€æ˜ */
            transform: translateY(-150%);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            z-index: 990; /* å±‚çº§ä½äºé¡¶éƒ¨å¯¼èˆªæ  */
        }
        
        /* Alpine æ¿€æ´»è¯¥ class æ—¶ï¼ŒæŠ½å±‰æ»‘å‡º */
        .filter-bar.mobile-open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        /* å†…éƒ¨è¡¨å•æ§ä»¶ï¼š100% æ’‘æ»¡å®½åº¦å¹¶å¢åŠ ç‚¹å‡»é¢ç§¯ */
        .filter-select { width: 100%; height: 42px; font-size: 15px; padding: 0 15px; }
        .search-wrapper { width: 100%; height: 42px; }
        .search-input { width: 100% !important; height: 100%; font-size: 15px; box-sizing: border-box; }
        .search-btn {
			height: 100%;
			padding: 10px;
			background-color: #0078d4;
			color: white;
			border: none;
			border-radius: 6px;
			font-size: 13px;
			font-weight: 600;
			cursor: pointer;
			transition: background 0.2s, transform 0.1s;
			display: flex;
			align-items: center;
			gap: 6px;
			box-shadow: none !important; /* ã€æ–°å¢ã€‘ï¼šå¼ºè¡Œå»é˜´å½± */
		}

        /* ä¿®å¤è‡ªåŠ¨è¡¥å…¨åˆ—è¡¨çš„å®½åº¦ */
        .autocomplete-list {
            width: 100%; 
            max-width: none;
            max-height: 40vh; /* é˜²æ­¢åˆ—è¡¨è¿‡é•¿æŒ¡ä½å…¨å± */
        }
        
        /* é¿å…æŠ½å±‰å±•å¼€æ—¶ï¼Œåº•éƒ¨çš„å†…å®¹ç´§è´´ç€å®ƒ */
        .char-grid { padding-top: 70px; }
    }
	
    /* --- ç½‘æ ¼ä¸å¡ç‰‡ (å¤ç”¨ä¹‹å‰çš„æ ·å¼) --- */
    .char-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        padding: 60px 20px 20px 20px;
    }
    .char-card {
        position: relative; display: block; aspect-ratio: 2 / 3; border-radius: 8px; overflow: hidden;
        text-decoration: none; background: #1a1a1a; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #333;
    }
    .char-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); border-color: #666; }
    .char-cover { width: 100%; height: 100%; position: relative; }
    .char-cover img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; }
    .char-cover img.loaded { opacity: 1; }
    .char-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); }
    .char-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 12px; box-sizing: border-box; }
    .char-name { color: #fff; font-weight: bold; font-size: 1.1em; text-shadow: 0 1px 2px rgba(0,0,0,1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
    .char-count { color: #ccc; font-size: 0.85em; }
    .loader-trigger { grid-column: 1 / -1; text-align: center; padding: 30px; color: #666; }
</style>

<script>
function tagsApp() {
    return {
        characters: [],
        page: 1,
        loading: false,
        hasMore: true,
        showNav: true,
        lastScrollY: 0,
        
        // 1. é»˜è®¤å€¼æ”¹ä¸º tag å’Œ folderï¼Œå¹¶ä¼˜å…ˆå°è¯•ä»æœ¬åœ°ç¼“å­˜è¯»å–
        searchQuery: '',
        searchType: localStorage.getItem('searchType') || 'tag',
        
        allTags: [],
        suggestions: [],
        selectedIndex: -1, // æ–°å¢ï¼šå½“å‰é€‰ä¸­çš„å»ºè®®è¯ç´¢å¼•
		mobileSearchOpen: false, // ã€æ–°å¢ã€‘ç§»åŠ¨ç«¯æœç´¢é¢æ¿å¼€å…³çŠ¶æ€

        init() {
            this.loadTagsCache();
            this.loadMore();

            // ç›‘å¬ä¸‹æ‹‰æ¡†å˜åŒ–ï¼Œä¸€æ—¦æ”¹å˜å°±å­˜å…¥æœ¬åœ°ç¼“å­˜
            this.$watch('searchType', (value) => localStorage.setItem('searchType', value));
        },

        async loadTagsCache() {
            try {
                const res = await fetch('/api/tags/all');
                this.allTags = await res.json();
            } catch(e) { console.error("Tags cache error", e); }
        },

        async loadMore() {
            if (this.loading || !this.hasMore) return;
            this.loading = true;
            try {
                const params = new URLSearchParams({
                    page: this.page,
                    search: this.searchQuery
                });
                const response = await fetch(`/api/characters?${params.toString()}`);
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    this.characters.push(...data.data);
                    this.page++;
                    this.hasMore = data.has_more;
                } else {
                    this.hasMore = false;
                }
            } catch (e) {
                console.error("Load failed", e);
                this.hasMore = false;
            } finally {
                this.loading = false;
            }
        },

        // --- æœç´¢è¾“å…¥å¤„ç† ---
        handleInput() {
            this.selectedIndex = -1; // è¾“å…¥æ–°å†…å®¹æ—¶é‡ç½®é€‰æ‹©ç´¢å¼•
            const val = this.searchQuery;
            const parts = val.split(',');
            const lastPart = parts[parts.length - 1].trim().toLowerCase();

            if (lastPart.length < 1) {
                this.suggestions = [];
                return;
            }

            this.suggestions = this.allTags
                .filter(t => t.name.toLowerCase().includes(lastPart))
                .slice(0, 15);
        },

        // --- é”®ç›˜ä¸Šä¸‹é”®å¯¼èˆªé€»è¾‘ ---
        navigateSuggestions(direction) {
            if (this.suggestions.length === 0) return;
            
            this.selectedIndex += direction;
            
            // å¾ªç¯æ»šåŠ¨
            if (this.selectedIndex < 0) {
                this.selectedIndex = this.suggestions.length - 1;
            } else if (this.selectedIndex >= this.suggestions.length) {
                this.selectedIndex = 0;
            }

            // è®©æ»šåŠ¨æ¡è·Ÿéšé€‰ä¸­çš„é¡¹è‡ªåŠ¨æ»šåŠ¨
            this.$nextTick(() => {
                const activeEl = document.querySelector('.suggestion-item.active');
                if (activeEl) {
                    activeEl.scrollIntoView({ block: 'nearest' });
                }
            });
        },

        // --- å›è½¦é”®å¤„ç† ---
        handleEnter() {
            // å¦‚æœä¸‹æ‹‰åˆ—è¡¨å¼€ç€ï¼Œä¸”é€‰ä¸­äº†æŸä¸€é¡¹ï¼Œåˆ™è§†ä¸ºè¡¥å…¨ Tag
            if (this.suggestions.length > 0 && this.selectedIndex >= 0) {
                this.selectSuggestion(this.suggestions[this.selectedIndex]);
            } else {
                // å¦åˆ™è§†ä¸ºç›´æ¥è§¦å‘æœç´¢
                this.performSearch();
            }
        },

        // --- ç‚¹é€‰/å›è½¦é€‰æ‹©å»ºè®® (è¿½åŠ æ¨¡å¼) ---
        selectSuggestion(item) {
            let current = this.searchQuery;
            const parts = current.split(',');
            
            parts[parts.length - 1] = ' ' + item.name; 
            
            this.searchQuery = parts.join(',') + ', ';
            
            // æ¸…ç†å»ºè®®å’Œç´¢å¼•
            this.suggestions = [];
            this.selectedIndex = -1;
            
            // åˆ©ç”¨ $nextTick ä¿è¯ Vue/Alpine çš„åŒå‘ç»‘å®šå®ŒæˆDOMæ›´æ–°åå†è®¡ç®—å…‰æ ‡ä½ç½®
            this.$nextTick(() => {
                const input = document.getElementById('searchInput');
                input.focus();
                // å°†å…‰æ ‡è®¾ç½®åˆ°å­—ç¬¦ä¸²æœ€æœ«å°¾
                const len = input.value.length;
                input.setSelectionRange(len, len);
            });
        },

        // --- æ‰§è¡Œæœç´¢ ---
        performSearch() {
			// ã€æ–°å¢ã€‘æ‰§è¡Œæœç´¢æ—¶è‡ªåŠ¨æ”¶èµ·ç§»åŠ¨ç«¯é¢æ¿
            this.mobileSearchOpen = false;
			
            const query = this.searchQuery.trim().replace(/,$/, ''); 
            
            if (this.searchType === 'tag' && query) {
                const encodedQ = encodeURIComponent(query);
                // ã€ä¿®æ”¹ã€‘å¼ºåˆ¶é»˜è®¤è·³è½¬åˆ°æ–‡ä»¶å¤¹æœç´¢é¡µ
                window.location.href = '/search/folders?q=' + encodedQ;
                return;
            }

            this.characters = [];
            this.page = 1;
            this.hasMore = true;
            this.loading = false;
            this.loadMore(); 
        },

        handleScroll() {
		// ã€æ–°å¢ã€‘å¦‚æœæœç´¢é¢æ¿å¼€ç€ï¼Œåˆ™å¼ºåˆ¶ä¿æŒå¯¼èˆªæ æ˜¾ç¤º
            if (this.mobileSearchOpen) {
                this.showNav = true;
                return;
            }
            const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;
            if (currentScrollY > this.lastScrollY && currentScrollY > 50) {
                this.showNav = false;
            } else {
                this.showNav = true;
            }
            this.lastScrollY = currentScrollY;
        }
    }
}
</script>
{% endblock %}