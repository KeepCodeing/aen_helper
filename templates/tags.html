{% extends "base.html" %}

{% block title %}è§’è‰²ç´¢å¼•{% endblock %}

{% block content %}
<div x-data="tagsApp()" x-cloak>

    <div class="nav" :class="{ 'nav-hidden': !showNav }">
        <div class="nav-group left">
            <a href="/">ğŸ  é¦–é¡µ</a>
            <span style="color: #444;">|</span>
            <div class="nav-title">è§’è‰²ç´¢å¼•</div>
        </div>
        
        <div class="nav-group right">
            <div class="filter-bar">
                
                <select class="filter-select" x-model="searchType" title="æœç´¢ç›®æ ‡">
                    <option value="char">ğŸ‘¤ æœè§’è‰²</option>
                    <option value="tag">ğŸ·ï¸ æœæ ‡ç­¾</option>
                </select>

                <select class="filter-select" x-model="viewMode" title="ç»“æœå±•ç¤ºæ–¹å¼">
                    <option value="all">ğŸ–¼ï¸ å…¨éƒ¨å›¾ç‰‡</option>
                    <option value="folder">ğŸ“‚ æ–‡ä»¶å¤¹å½’ç±»</option>
                </select>
                
                <div class="search-wrapper">
                    <input type="text" 
                           class="search-input" 
                           placeholder="è¾“å…¥åç§°æˆ–æ ‡ç­¾..." 
                           x-model="searchQuery"
                           @input="handleInput()"
                           @keydown.enter="performSearch()"
                           id="searchInput">
                    
                    <div class="autocomplete-list" 
                         x-show="suggestions.length > 0" 
                         @click.outside="suggestions = []">
                        <template x-for="item in suggestions">
                            <div class="suggestion-item" @click="selectSuggestion(item)">
                                <span x-text="item.name"></span>
                                <span class="count" x-text="item.count"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <button class="search-btn" @click="performSearch()">
                    ğŸ” æœç´¢
                </button>
            </div>
        </div>
    </div>

    <div class="grid-container char-grid" @scroll.window="handleScroll()">
        
        <template x-for="char in characters" :key="char.name">
            <a :href="viewMode === 'folder' 
                      ? '/tags/folders/' + encodeURIComponent(char.name) 
                      : '/tags/random/' + encodeURIComponent(char.name)" 
               class="char-card">
               
                <div class="char-cover">
                    <img :src="'/media/' + char.cover" loading="lazy" :alt="char.name" @load="$el.classList.add('loaded')">
                    <div class="char-overlay"></div>
                </div>
                <div class="char-info">
                    <div class="char-name" x-text="char.name"></div>
                    <div class="char-count" x-text="char.count + ' å¼ '"></div>
                </div>
            </a>
        </template>

        <div class="loader-trigger" x-intersect="loadMore()">
            <span x-show="loading" class="loading-text">â³ æ­£åœ¨åŠ è½½...</span>
            <span x-show="!hasMore && characters.length > 0" class="end-text">--- åˆ°åº•äº† ---</span>
            <span x-show="!loading && characters.length === 0" class="empty-text">æœªæ‰¾åˆ°åŒ¹é…çš„è§’è‰²</span>
        </div>
    </div>

</div>

<style>
    /* --- æœç´¢æ å¸ƒå±€ä¼˜åŒ– --- */
    .filter-bar { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        margin-right: 10px; 
        height: 36px; /* ç»Ÿä¸€é«˜åº¦ */
    }

    /* ä¸‹æ‹‰æ¡†ç¾åŒ– */
    .filter-select { 
        background-color: #333; 
        color: #eee; 
        border: 1px solid #555; 
        padding: 0 28px 0 12px; /* ç»™å³ä¾§ç®­å¤´ç•™ç©º */
        border-radius: 6px; 
        font-size: 13px; 
        cursor: pointer; 
        height: 100%;
        outline: none;
        appearance: none; /* ç§»é™¤æµè§ˆå™¨é»˜è®¤ç®­å¤´ */
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 14px;
        transition: border-color 0.2s, background-color 0.2s;
    }
    .filter-select:hover { background-color: #444; border-color: #777; }
    .filter-select:focus { border-color: #0078d4; background-color: #222; }

    /* è¾“å…¥æ¡†å®¹å™¨ */
    .search-wrapper { position: relative; height: 100%; }
    
    /* è¾“å…¥æ¡†ç¾åŒ– */
    .search-input { 
        background: #222; 
        border: 1px solid #444; 
        color: #fff; 
        padding: 0 12px; 
        border-radius: 6px; 
        width: 200px; 
        height: 100%;
        box-sizing: border-box; /* ç¡®ä¿ padding ä¸æ’‘å¤§é«˜åº¦ */
        transition: width 0.3s, border-color 0.3s; 
        font-size: 14px;
    }
    .search-input:focus { 
        width: 300px; 
        background: #1a1a1a; 
        outline: none; 
        border-color: #0078d4; 
        box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
    }

    /* æœç´¢æŒ‰é’®ç¾åŒ– */
    .search-btn {
        height: 100%;
        padding: 0 16px;
        background-color: #0078d4;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .search-btn:hover { background-color: #0063b1; }
    .search-btn:active { transform: scale(0.96); }

    /* è‡ªåŠ¨è¡¥å…¨ä¸‹æ‹‰ */
    .autocomplete-list { 
        position: absolute; 
        top: calc(100% + 4px); 
        left: 0; 
        min-width: 100%; /* è‡³å°‘å’Œè¾“å…¥æ¡†ä¸€æ ·å®½ */
        max-width: 400px; /* ä¹Ÿå¯ä»¥æ›´å®½ */
        background: #1e1e1e; 
        border: 1px solid #444;
        border-radius: 6px; 
        max-height: 300px; 
        overflow-y: auto; 
        z-index: 2000; 
        box-shadow: 0 8px 16px rgba(0,0,0,0.6); 
    }
    .suggestion-item { 
        padding: 10px 14px; 
        border-bottom: 1px solid #333; 
        cursor: pointer; 
        display: flex; 
        justify-content: space-between; 
        color: #ddd;
        font-size: 13px;
        transition: background 0.1s;
    }
    .suggestion-item:hover { background: #0078d4; color: #fff; }
    .suggestion-item:hover .count { color: #eee; } /* Hover æ—¶è®¡æ•°é¢œè‰²å˜æ·¡ */
    .suggestion-item .count { color: #666; font-size: 0.9em; }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
        /* ç§»åŠ¨ç«¯æŠŠæœç´¢æ æ”¾åˆ°åº•ä¸‹æˆ–è€…ç®€åŒ– */
        .nav-group.right { display: none; } /* æš‚æ—¶éšè—ï¼Œæˆ–è€…éœ€è¦å•ç‹¬åšç§»åŠ¨ç«¯UI */
        /* æˆ–è€…ï¼š */
        .filter-bar { gap: 4px; }
        .filter-select { font-size: 0; padding: 0 20px 0 8px; width: 40px; } /* åªæ˜¾ç¤ºå›¾æ ‡ */
        .search-input { width: 120px; }
        .search-input:focus { width: 150px; }
        .search-btn { font-size: 0; padding: 0 12px; } /* åªæ˜¾ç¤ºå›¾æ ‡ */
    }

    /* --- ç½‘æ ¼ä¸å¡ç‰‡ (å¤ç”¨ä¹‹å‰çš„æ ·å¼) --- */
    .char-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        padding: 60px 20px 20px 20px;
    }
    .char-card {
        position: relative; display: block; aspect-ratio: 2 / 3; border-radius: 8px; overflow: hidden;
        text-decoration: none; background: #1a1a1a; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #333;
    }
    .char-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); border-color: #666; }
    .char-cover { width: 100%; height: 100%; position: relative; }
    .char-cover img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; }
    .char-cover img.loaded { opacity: 1; }
    .char-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); }
    .char-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 12px; box-sizing: border-box; }
    .char-name { color: #fff; font-weight: bold; font-size: 1.1em; text-shadow: 0 1px 2px rgba(0,0,0,1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
    .char-count { color: #ccc; font-size: 0.85em; }
    .loader-trigger { grid-column: 1 / -1; text-align: center; padding: 30px; color: #666; }
</style>

<script>
function tagsApp() {
    return {
        characters: [],
        page: 1,
        loading: false,
        hasMore: true,
        showNav: true,
        lastScrollY: 0,
        
        searchQuery: '',
        searchType: 'char',
        viewMode: 'all',
        
        allTags: [],
        suggestions: [],

        init() {
            this.loadTagsCache();
            this.loadMore();
        },

        async loadTagsCache() {
            try {
                const res = await fetch('/api/tags/all');
                this.allTags = await res.json();
            } catch(e) { console.error("Tags cache error", e); }
        },

        async loadMore() {
            if (this.loading || !this.hasMore) return;
            this.loading = true;
            try {
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                const params = new URLSearchParams({
                    page: this.page,
                    search: this.searchQuery
                });
                const response = await fetch(`/api/characters?${params.toString()}`);
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    this.characters.push(...data.data);
                    this.page++;
                    this.hasMore = data.has_more;
                } else {
                    this.hasMore = false;
                }
            } catch (e) {
                console.error("Load failed", e);
                this.hasMore = false;
            } finally {
                this.loading = false;
            }
        },

        // --- æœç´¢è¾“å…¥å¤„ç† ---
        handleInput() {
            const val = this.searchQuery;
            // æå–æœ€åä¸€ä¸ªé€—å·åçš„å†…å®¹è¿›è¡Œè¡¥å…¨
            const parts = val.split(',');
            const lastPart = parts[parts.length - 1].trim().toLowerCase();

            if (lastPart.length < 1) {
                this.suggestions = [];
                // å¦‚æœç”¨æˆ·å®Œå…¨æ¸…ç©ºäº†è¾“å…¥æ¡†ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦è‡ªåŠ¨é‡ç½®åˆ—è¡¨
                // è¿™é‡Œæˆ‘ä»¬ä¿æŒæ‰‹åŠ¨ç‚¹å‡»æœç´¢æŒ‰é’®æ‰è§¦å‘é‡ç½®ï¼Œä½“éªŒæ›´ç»Ÿä¸€
                return;
            }

            // è¿‡æ»¤é€»è¾‘
            this.suggestions = this.allTags
                .filter(t => t.name.toLowerCase().includes(lastPart))
                .slice(0, 15);
        },

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šç‚¹é€‰å»ºè®® (è¿½åŠ æ¨¡å¼) ---
        selectSuggestion(item) {
            // 1. è·å–å½“å‰è¾“å…¥
            let current = this.searchQuery;
            const parts = current.split(',');
            
            // 2. æ›¿æ¢æœ€åä¸€éƒ¨åˆ†ä¸ºé€‰ä¸­çš„å®Œæ•´æ ‡ç­¾
            parts[parts.length - 1] = ' ' + item.name; // åŠ ä¸ªç©ºæ ¼ç¾è§‚
            
            // 3. é‡æ–°ç»„åˆå¹¶åŠ ä¸Šé€—å·ï¼Œæ–¹ä¾¿è¾“å…¥ä¸‹ä¸€ä¸ª
            this.searchQuery = parts.join(',') + ', ';
            
            // 4. æ¸…ç†å»ºè®®ï¼Œèšç„¦è¾“å…¥æ¡†
            this.suggestions = [];
            document.getElementById('searchInput').focus();
            
            // æ³¨æ„ï¼šè¿™é‡Œä¸å†è°ƒç”¨ performSearch()ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®
        },

        // --- æ‰§è¡Œæœç´¢ ---
        performSearch() {
            const query = this.searchQuery.trim().replace(/,$/, ''); // å»æ‰æœ«å°¾å¯èƒ½çš„é€—å·
            
            // åœºæ™¯ 1: æœæ ‡ç­¾ -> è·³è½¬
            if (this.searchType === 'tag' && query) {
                const encodedQ = encodeURIComponent(query);
                if (this.viewMode === 'folder') {
                    window.location.href = '/search/folders?q=' + encodedQ;
                } else {
                    window.location.href = '/search?q=' + encodedQ;
                }
                return;
            }

            // åœºæ™¯ 2: æœè§’è‰² (æˆ–ç©ºæœ) -> åˆ·æ–°å½“å‰ç½‘æ ¼
            this.characters = [];
            this.page = 1;
            this.hasMore = true;
            this.loading = false;
            this.loadMore(); // è¿™é‡Œä¼šè¯»å– this.searchQuery
        },

        handleScroll() {
            const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;
            if (currentScrollY > this.lastScrollY && currentScrollY > 50) {
                this.showNav = false;
            } else {
                this.showNav = true;
            }
            this.lastScrollY = currentScrollY;
        }
    }
}
</script>
{% endblock %}